<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MedicinePro</title>

    <!-- Meta Tags per PWA -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MedicinePro">
    <link rel="apple-touch-icon" href="https://i.ibb.co/N6db36Sf/medicine.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Manifest Inline -->
    <link rel="manifest" id="my-manifest">

    <style>
        /* Dimensione uniforme per orari e giorni */
        .time-btn,
        .day-btn,
        .detail-time-btn {
            height: 40px;
            min-height: 40px;
            font-size: 11px;
            padding: 0 10px !important;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        .time-btn.selected,
        .day-btn.selected,
        .detail-time-btn.selected {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .avatar-btn {
            transition: all 0.2s;
            border: 2px solid transparent;
            opacity: 0.6;
        }

            .avatar-btn.selected {
                border-color: #2563eb;
                background-color: #eff6ff;
                color: #2563eb;
                opacity: 1;
                transform: scale(1.05);
            }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .med-checkbox {
            appearance: none;
            width: 2.5rem;
            height: 2.5rem;
            border: 3px solid #cbd5e1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            flex-shrink: 0;
        }

            .med-checkbox:checked {
                background-color: #22c55e;
                border-color: #22c55e;
            }

                .med-checkbox:checked::after {
                    content: '\f00c';
                    font-family: 'Font Awesome 6 Free';
                    font-weight: 900;
                    color: white;
                    font-size: 1.2rem;
                }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        /* Stili specifici per le categorie temporali */
        .med-card-mattina {
            background-color: #fff7ed;
            border-color: #ffedd5;
        }

        .med-card-pomeriggio {
            background-color: #fefce8;
            border-color: #fef9c3;
        }

        .med-card-sera {
            background-color: #f5f3ff;
            border-color: #ede9fe;
        }

        .med-card-taken {
            background-color: #f0fdf4 !important;
            border-color: #dcfce7 !important;
        }

        .xs\:inline {
            display: none;
        }

        @media (min-width: 400px) {
            .xs\:inline {
                display: inline;
            }
        }

        /* Camera Scanner UI */
        #camera-container {
            position: fixed;
            inset: 0;
            background: black;
            z-index: 100;
            display: none;
            flex-direction: column;
        }

        #camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            inset: 0;
            border: 2px solid rgba(255,255,255,0.3);
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scanner-frame {
            width: 80%;
            height: 40%;
            border: 2px solid #3b82f6;
            border-radius: 1rem;
            box-shadow: 0 0 0 4000px rgba(0,0,0,0.5);
            position: relative;
        }

        .scanner-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #3b82f6;
            top: 0;
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            from {
                top: 0%;
            }

            to {
                top: 100%;
            }
        }

        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .therapy-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 2px;
            white-space: nowrap;
        }

        .therapy-badge {
            margin-left: -6px;
        }

            .therapy-badge .label {
                font-weight: 700;
            }

            .therapy-badge .sub {
                font-size: 11px;
                opacity: 0.9;
            }

            .therapy-badge .dot {
                opacity: 0.5;
            }

            /* COLORI BADGE */
            .therapy-badge.green {
                background: #ecfdf5;
                color: #047857;
            }

            .therapy-badge.orange {
                background: #fff7ed;
                color: #c2410c;
            }

            .therapy-badge.red {
                background: #fef2f2;
                color: #b91c1c;
            }

        .therapy-badge {
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.04);
        }

        /* COLORE CARD */
        .med-card.therapy-green {
            border-left: 4px solid #10b981;
        }

        .med-card.therapy-orange {
            border-left: 4px solid #f97316;
        }

        .med-card.therapy-red {
            border-left: 4px solid #dc2626;
        }

        /* CARD INATTIVA: Disabilita il corpo principale MA lascia i bottoni attivi */
        .med-card-inactive {
            opacity: 0.55;
            background-color: #f3f4f6 !important; /* Grigio chiaro per indicare disabilitato */
            border-color: #e5e7eb !important;
        }

        .med-card-inactive .card-main-content {
            pointer-events: none; /* Disabilita click su checkbox e testo */
            opacity: 0.5;
        }

        .med-card-inactive .card-actions {
            pointer-events: auto; /* Riabilita click sui bottoni azione */
            opacity: 1;
        }

        .therapy-badge.gray {
            background: #f1f5f9;
            color: #475569;
        }

        .therapy-day {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 6px;
            font-weight: 700;
            display: flex;
            flex-direction: column; /* Cambiato per allineare numero e icone */
            align-items: center;
            justify-content: flex-start; /* Allinea in alto */
            padding-top: 2px;
            cursor: pointer;
            transition: transform 0.1s;
            position: relative;
        }
        
        .therapy-day:active {
            transform: scale(0.9);
        }

        .therapy-out {
            background: #f1f5f9;
            color: #94a3b8;
            cursor: default;
            justify-content: center; /* Centra solo se non attivo */
            padding-top: 0;
        }

        /* Colori TENUI (Pastello) */
        .therapy-mid {
            background: #fef08a; /* Yellow-200 */
            color: #854d0e; /* Yellow-900 */
        }

        .therapy-start {
            background: #86efac; /* Green-300 */
            color: #14532d; /* Green-900 */
        }

        .therapy-end {
            background: #fca5a5; /* Red-300 */
            color: #7f1d1d; /* Red-900 */
        }

        .therapy-skip {
            background: #e5e7eb;
            color: #9ca3af;
        }
        
        .clickable-day:hover {
            filter: brightness(0.95);
        }
        
        /* Stile icone nel calendario */
        .cal-icon-wrapper {
            display: flex;
            gap: 3px;
            margin-top: 0px;
            justify-content: center;
            position: absolute;
            bottom: 4px;
            width: 100%;
        }

        /* FREQUENCY OPTION SELECTED */
        .freq-option.selected {
            border-color: #2563eb;
            background-color: #eff6ff;
            color: #2563eb;
        }
        .freq-option.selected .check-icon {
            display: inline-block;
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="bg-blue-600 text-white p-4 shadow-md z-20 flex justify-between items-center shrink-0 h-16">
        <div class="flex items-center gap-3">
            <button id="btn-back" class="hidden text-xl p-1 active:scale-95 transition-transform" aria-label="Indietro">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <h1 class="text-xl font-bold tracking-wide flex items-center gap-2">
                <i class="fa-solid fa-pills"></i> MedicinePro
            </h1>
        </div>

        <div class="flex gap-2">
            <button onclick="app.showSettings()" class="text-xl p-2 hover:bg-blue-700 rounded-full transition-colors" title="Impostazioni">
                <i class="fa-solid fa-cog"></i>
            </button>
        </div>
    </header>

    <input type="file" id="import-file" accept=".json" class="hidden" onchange="app.handleImport(this)">

    <!-- MAIN -->
    <main id="app-container" class="flex-1 overflow-y-auto no-scrollbar relative p-4 max-w-lg mx-auto w-full">

        <!-- VISTA LISTA PROFILI -->
        <section id="view-profiles" class="fade-in space-y-4">
            <div class="bg-white p-6 rounded-2xl card-shadow text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">I tuoi Profili</h2>
                <p class="text-slate-500 text-sm">Monitora le assunzioni quotidiane.</p>
            </div>
            <div id="profiles-list" class="space-y-3"></div>
            <button onclick="app.showModal('modal-add-profile')" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                <i class="fa-solid fa-user-plus"></i> Aggiungi Profilo
            </button>
        </section>

        <!-- VISTA DETTAGLIO PROFILO -->
        <section id="view-medications" class="hidden fade-in pb-24">
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <h2 id="current-profile-name" class="text-2xl font-bold text-slate-800 truncate max-w-[180px]">Profilo</h2>
                        <button onclick="app.openEditProfileModal()" class="text-slate-400 hover:text-blue-600 p-1.5 transition-colors">
                            <i class="fa-solid fa-pencil text-sm"></i>
                        </button>
                    </div>
                    <div class="flex items-center gap-3 mt-1">
                        <p id="current-date-display" class="text-[10px] text-slate-500 uppercase font-bold tracking-wider"></p>
                        <button id="btn-uncheck-all" onclick="app.uncheckAllMeds()" class="hidden text-[10px] text-red-500 uppercase font-bold tracking-wider hover:underline">
                            Deseleziona tutto
                        </button>
                    </div>
                </div>
                <div class="flex flex-col gap-2 items-end">
                    <button onclick="app.exportProfileTxt()" class="text-blue-600 text-xs px-3 py-1.5 border border-blue-200 rounded-lg hover:bg-blue-50 flex items-center gap-1 transition-all">
                        <i class="fa-solid fa-file-lines"></i> <span class="xs:inline">Esporta TXT</span>
                    </button>
                    <button onclick="app.deleteCurrentProfile()" class="text-red-500 text-xs px-3 py-1.5 border border-red-200 rounded-lg hover:bg-red-50 flex items-center gap-1 transition-all">
                        <i class="fa-solid fa-trash"></i> <span class="xs:inline">Elimina Profilo</span>
                    </button>
                </div>
            </div>

            <div id="med-list-mattina" class="mb-6"></div>
            <div id="med-list-pomeriggio" class="mb-6"></div>
            <div id="med-list-sera" class="mb-6"></div>

            <div id="med-empty-state" class="hidden flex flex-col items-center justify-center py-12 text-slate-400">
                <i class="fa-solid fa-prescription-bottle-medical text-5xl mb-4 text-slate-200"></i>
                <p>Nessun farmaco aggiunto.</p>
            </div>

            <button onclick="app.prepareNewMed()" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-xl flex items-center justify-center text-2xl active:scale-90 transition-transform z-30">
                <i class="fa-solid fa-plus"></i>
            </button>
        </section>

        <!-- VISTA IMPOSTAZIONI -->
        <section id="view-settings" class="hidden fade-in space-y-6">
            <div class="flex items-center gap-4 mb-2">
                <h2 class="text-2xl font-bold text-slate-800">Impostazioni</h2>
            </div>

            <div class="bg-white p-5 rounded-2xl card-shadow space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-600 mb-2">Google Gemini API Key</label>
                    <input type="password" id="input-settings-apikey" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Inserisci la tua API Key">
                    <p class="text-[11px] text-slate-400 mt-2 italic">La chiave serve per abilitare il riconoscimento dei farmaci tramite fotocamera.</p>
                </div>
                <button onclick="app.saveSettings()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-md active:scale-95 transition-all">
                    Salva Impostazioni
                </button>
            </div>

            <div class="bg-white p-5 rounded-2xl card-shadow">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-database text-blue-500"></i> Gestione Dati
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.triggerImport()" class="flex flex-col items-center justify-center p-4 border border-slate-200 rounded-xl hover:bg-slate-50 transition-colors">
                        <i class="fa-solid fa-file-import text-blue-600 mb-2"></i>
                        <span class="text-xs font-bold">Importa JSON</span>
                    </button>
                    <button onclick="app.exportData()" class="flex flex-col items-center justify-center p-4 border border-slate-200 rounded-xl hover:bg-slate-50 transition-colors">
                        <i class="fa-solid fa-download text-green-600 mb-2"></i>
                        <span class="text-xs font-bold">Esporta Backup</span>
                    </button>
                </div>
                <button onclick="app.resetAllData()" class="w-full mt-4 bg-red-50 text-red-600 py-3 rounded-xl font-bold border border-red-100 hover:bg-red-100 transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-triangle-exclamation"></i> Resetta tutti i dati
                </button>
            </div>
        </section>
    </main>

    <!-- MODALI DI SISTEMA CUSTOM (Alert, Confirm, Frequency) -->
    
    <!-- MODALE ALERT (Sostituisce alert()) -->
    <div id="modal-alert" class="hidden fixed inset-0 modal-overlay z-[70] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
            <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mx-auto mb-4 text-xl">
                <i class="fa-solid fa-info"></i>
            </div>
            <h3 id="alert-title" class="text-xl font-bold text-slate-800 mb-2">Avviso</h3>
            <p id="alert-message" class="text-slate-500 mb-6 text-sm"></p>
            <button onclick="app.closeModal('modal-alert')" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700 transition-transform active:scale-95">OK</button>
        </div>
    </div>

    <!-- MODALE CONFIRM (Sostituisce confirm()) -->
    <div id="modal-confirm" class="hidden fixed inset-0 modal-overlay z-[70] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
            <div class="w-12 h-12 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center mx-auto mb-4 text-xl">
                <i class="fa-solid fa-question"></i>
            </div>
            <h3 id="confirm-title" class="text-xl font-bold text-slate-800 mb-2">Conferma</h3>
            <p id="confirm-message" class="text-slate-500 mb-6 text-sm"></p>
            <div class="flex gap-3">
                <button onclick="app.closeModal('modal-confirm')" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-colors">Annulla</button>
                <button id="confirm-btn-yes" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700 transition-transform active:scale-95">Conferma</button>
            </div>
        </div>
    </div>

    <!-- MODALE SCELTA FREQUENZA (Sostituisce select) -->
    <div id="modal-frequency" class="hidden fixed inset-0 modal-overlay z-[70] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Frequenza Assunzione</h3>
            <div class="space-y-3">
                <button onclick="app.selectFrequency('daily')" class="freq-option w-full p-4 border rounded-xl flex items-center justify-between transition-all hover:bg-slate-50" data-val="daily">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fa-solid fa-calendar-day"></i></div>
                        <span class="font-bold text-slate-700">Ogni Giorno</span>
                    </div>
                    <i class="fa-solid fa-check text-blue-600 hidden check-icon"></i>
                </button>
                <button onclick="app.selectFrequency('alternate')" class="freq-option w-full p-4 border rounded-xl flex items-center justify-between transition-all hover:bg-slate-50" data-val="alternate">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center"><i class="fa-solid fa-calendar-days"></i></div>
                        <span class="font-bold text-slate-700">Giorni Alterni</span>
                    </div>
                    <i class="fa-solid fa-check text-blue-600 hidden check-icon"></i>
                </button>
            </div>
            <button onclick="app.closeModal('modal-frequency')" class="w-full mt-6 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-colors">Annulla</button>
        </div>
    </div>

    <!-- ALTRI MODALI -->

    <!-- MODALE AGGIUNGI PROFILO -->
    <div id="modal-add-profile" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold mb-4">Nuovo Profilo</h3>

            <p class="text-xs text-slate-500 font-bold uppercase mb-2">Scegli Avatar</p>
            <div class="grid grid-cols-4 gap-3 mb-4">
                <button onclick="app.selectAvatar('man')" class="avatar-btn rounded-xl p-2 flex items-center justify-center text-2xl bg-slate-50 text-slate-400" data-avatar="man">
                    <i class="fa-solid fa-person"></i>
                </button>
                <button onclick="app.selectAvatar('woman')" class="avatar-btn rounded-xl p-2 flex items-center justify-center text-2xl bg-slate-50 text-slate-400" data-avatar="woman">
                    <i class="fa-solid fa-person-dress"></i>
                </button>
                <button onclick="app.selectAvatar('dog')" class="avatar-btn rounded-xl p-2 flex items-center justify-center text-2xl bg-slate-50 text-slate-400" data-avatar="dog">
                    <i class="fa-solid fa-dog"></i>
                </button>
                <button onclick="app.selectAvatar('cat')" class="avatar-btn rounded-xl p-2 flex items-center justify-center text-2xl bg-slate-50 text-slate-400" data-avatar="cat">
                    <i class="fa-solid fa-cat"></i>
                </button>
            </div>

            <p class="text-xs text-slate-500 font-bold uppercase mb-2">Nome</p>
            <input type="text" id="input-profile-name" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Es. Mario Rossi">
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="app.closeModal('modal-add-profile')" class="px-4 py-2 text-slate-500">Annulla</button>
                <button onclick="app.createProfile()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium">Crea</button>
            </div>
        </div>
    </div>

    <!-- MODALE MODIFICA NOME PROFILO -->
    <div id="modal-edit-profile" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold mb-4">Rinomina Profilo</h3>
            <input type="text" id="input-edit-profile-name" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="app.closeModal('modal-edit-profile')" class="px-4 py-2 text-slate-500">Annulla</button>
                <button onclick="app.saveProfileName()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium">Salva</button>
            </div>
        </div>
    </div>

    <!-- MODALE VISUALIZZA NOTE -->
    <div id="modal-show-note" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative">
            <button onclick="app.closeModal('modal-show-note')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 p-2">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            <h3 id="note-modal-title" class="text-lg font-bold text-slate-800 mb-2 pr-8">Titolo Farmaco</h3>
            <div class="bg-yellow-50 border border-yellow-100 rounded-xl p-4 text-sm text-slate-700 max-h-60 overflow-y-auto">
                <i class="fa-solid fa-note-sticky text-yellow-400 mb-2 block text-lg"></i>
                <p id="note-modal-content" class="whitespace-pre-wrap"></p>
            </div>
            <div class="flex justify-end mt-4">
                <button onclick="app.closeModal('modal-show-note')" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg font-bold text-sm transition-colors">Chiudi</button>
            </div>
        </div>
    </div>
    
    <!-- MODALE DETTAGLIO GIORNO (Nuovo) -->
    <!-- Z-Index aumentato a 60 per apparire sopra il modale principale -->
    <div id="modal-day-detail" class="hidden fixed inset-0 modal-overlay z-[60] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative">
            <h3 class="text-xl font-bold text-slate-800 mb-1">Modifica Giorno</h3>
            <p id="day-detail-date" class="text-sm text-slate-500 font-semibold mb-5 uppercase tracking-wide"></p>
            
            <p class="text-xs text-slate-400 mb-3">Seleziona quando assumere il farmaco in questa data specifica:</p>
            
            <div class="space-y-3 mb-6">
                <button onclick="app.toggleDayDetailTime('Mattina')" class="detail-time-btn w-full p-3 border border-slate-200 rounded-xl outline-none text-sm transition-all" data-val="Mattina">
                    <i class="fa-solid fa-sun mr-3 text-orange-500"></i> Mattina
                </button>
                <button onclick="app.toggleDayDetailTime('Pomeriggio')" class="detail-time-btn w-full p-3 border border-slate-200 rounded-xl outline-none text-sm transition-all" data-val="Pomeriggio">
                    <i class="fa-solid fa-cloud-sun mr-3 text-yellow-500"></i> Pomeriggio
                </button>
                <button onclick="app.toggleDayDetailTime('Sera')" class="detail-time-btn w-full p-3 border border-slate-200 rounded-xl outline-none text-sm transition-all" data-val="Sera">
                    <i class="fa-solid fa-moon mr-3 text-indigo-500"></i> Sera
                </button>
            </div>

            <div class="flex justify-end gap-3">
                <button onclick="app.closeModal('modal-day-detail')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-50 rounded-lg transition-colors">Annulla</button>
                <button onclick="app.saveDayDetail()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 transition-transform active:scale-95">Salva Modifiche</button>
            </div>
        </div>
    </div>

    <!-- MODALE FARMACO (Aggiunta/Modifica) -->
    <div id="modal-med" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-0 overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 id="med-modal-title" class="text-lg font-bold text-slate-800">Farmaco</h3>
                <button onclick="app.startScanner()" id="btn-scan" class="bg-blue-100 text-blue-700 px-3 py-1.5 rounded-lg hover:bg-blue-200 transition-colors flex items-center gap-2 text-xs font-bold shadow-sm">
                    <i class="fa-solid fa-camera"></i> SCANNER AI
                </button>
            </div>

            <div id="med-modal-content" class="p-5 overflow-y-auto custom-scrollbar space-y-5">
                <!-- Nome -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Nome Farmaco</label>
                    <input type="text" id="input-med-name" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-shadow" placeholder="Es. Pantoprazolo 20mg">
                </div>

                <!-- Dettagli -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Forma</label>
                        <input type="text" id="input-med-category" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Es. Pillole">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Dose</label>
                        <input type="text" id="input-med-dose" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Es. 1, 1/2, 1/4, 0,25 ...">
                    </div>
                </div>

                <!-- Note / A cosa serve -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Note / A cosa serve</label>
                    <textarea id="input-med-usage"
                              rows="4"
                              class="w-full p-2 rounded-lg border border-slate-200 text-sm resize-none
                        min-h-[96px] max-h-[160px] overflow-y-auto
                        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Note / A cosa serve">
                    </textarea>
                </div>

                <!--Gestione Scorte -->
                <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                    <p class="text-xs font-bold text-emerald-700 uppercase mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-boxes-stacked text-emerald-600"></i> Gestione Scorte
                    </p>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-semibold text-slate-500 mb-1">In Scatola</label>
                            <input id="med-box-qty" type="number" min="0" step="0.5" class="w-full border border-slate-200 rounded-lg p-2 text-sm focus:border-blue-500 outline-none" placeholder="0">
                        </div>
                        <div>
                            <label class="block text-[10px] font-semibold text-slate-500 mb-1">Soglia Avviso</label>
                            <input id="med-min-qty" type="number" min="0" step="1" class="w-full border border-slate-200 rounded-lg p-2 text-sm focus:border-blue-500 outline-none" placeholder="0">
                        </div>
                    </div>
                </div>

                <!-- Periodo Terapia -->
                <div class="p-4 bg-blue-50 rounded-2xl border border-blue-100 mb-4">
                    <p class="text-xs font-bold text-blue-700 uppercase mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-calendar-days text-blue-600"></i> Periodo Terapia
                    </p>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-semibold text-slate-500 mb-1">Inizio terapia</label>
                            <input type="date" id="med-start-date" class="w-full border border-slate-200 rounded-lg p-2 text-sm focus:border-blue-500 outline-none bg-white">
                        </div>
                        <div>
                            <label class="block text-[10px] font-semibold text-slate-500 mb-1">Durata (giorni)</label>
                            <input type="number" id="med-duration" min="1" class="w-full border border-slate-200 rounded-lg p-2 text-sm focus:border-blue-500 outline-none bg-white" placeholder="0">
                        </div>
                    </div>
                </div>

                <!-- Frequenza (MODIFICATO CON MODALE) -->
                <div class="mt-3">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Frequenza</label>
                    
                    <div onclick="app.openFrequencyModal()" class="w-full p-3 border border-slate-200 rounded-xl flex items-center justify-between bg-white cursor-pointer active:bg-slate-50 transition-colors">
                        <div class="flex items-center gap-3">
                            <i id="freq-icon-display" class="fa-solid fa-calendar-day text-slate-400"></i>
                            <span id="freq-text-display" class="text-sm font-semibold text-slate-700">Ogni giorno</span>
                        </div>
                        <i class="fa-solid fa-chevron-right text-slate-300 text-xs"></i>
                    </div>
                    <input type="hidden" id="med-frequency" value="daily">
                </div>

                <!-- Calendario Semplificato-->
                <div id="therapy-preview" class="mt-3 hidden">
                    <p class="text-xs font-bold text-slate-500 uppercase mb-2 ml-1">
                        Prossimi giorni
                    </p>
                    <div id="therapy-calendar" class="flex gap-2 overflow-x-auto pb-2"></div>
                </div>

                <!-- Calendario Mensile-->
                <!-- Aggiunto max-w e mx-auto per ridurre dimensione -->
                <div id="therapy-month-wrapper" class="mt-4 hidden select-none touch-pan-y w-full">
                    <p class="text-xs font-bold text-slate-500 uppercase mb-2">
                        Calendario mensile <span class="text-[9px] font-normal text-slate-400 ml-1">(Tocca un giorno per modificare)</span>
                    </p>
                    <div id="therapy-month-header"
                         class="text-center font-bold text-slate-500 uppercase mb-2">
                    </div>
                    <div id="therapy-month-weekdays"
                         class="grid grid-cols-7 text-center text-[10px] font-bold text-slate-400 mb-1">
                        <div>L</div>
                        <div>M</div>
                        <div>M</div>
                        <div>G</div>
                        <div>V</div>
                        <div>S</div>
                        <div>D</div>
                    </div>
                    <!-- Gap ridotto e font ridotto -->
                    <div id="therapy-month" class="grid grid-cols-7 gap-0.5 text-center text-[10px]"></div>
                </div>

                <!-- Leggenda Semaforo -->
                <div id="therapy-legend" class="hidden mt-2 text-[9px] text-slate-400">
                    ðŸŸ¢ Prima assunzione Â· ðŸŸ¡ Intermedia Â· ðŸ”´ Ultima
                </div>

                <!-- Stato Terapia -->
                <div id="therapy-status-box" class="hidden p-3 rounded-xl border mt-3 text-sm flex items-center gap-3">
                    <span id="therapy-badge" class="px-3 py-1 rounded-full text-xs font-bold"></span>
                    <span id="therapy-countdown" class="text-slate-700"></span>
                </div>

                <!-- Orari -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Momento della giornata</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="app.toggleTimeSelection('Mattina', this)" class="time-btn w-full p-3 border border-slate-200 rounded-xl outline-none text-sm" data-val="Mattina"><i class="fa-solid fa-sun mr-2 text-orange-500"></i> Mattina</button>
                        <button onclick="app.toggleTimeSelection('Pomeriggio', this)" class="time-btn w-full p-3 border border-slate-200 rounded-xl outline-none text-sm" data-val="Pomeriggio"><i class="fa-solid fa-cloud-sun mr-2 text-yellow-500"></i> Pom.</button>
                        <button onclick="app.toggleTimeSelection('Sera', this)" class="time-btn w-full p-3 border border-slate-200 rounded-xl outline-none text-sm" data-val="Sera"><i class="fa-solid fa-moon mr-2 text-indigo-500"></i> Sera</button>
                    </div>
                </div>

                <!-- Giorni -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Giorni</label>
                    <div class="grid grid-cols-7 gap-1">
                        <button class="day-btn time-btn w-full p-3 border border-slate-200 rounded-xl outline-none text-sm" data-day="Lun" onclick="app.toggleDaySelection('Lun', this)">L</button>
                        <button class="day-btn time-btn w-full p-3 border border-slate-200 rounded-xl outline-none text-sm" data-day="Mar" onclick="app.toggleDaySelection('Mar', this)">M</button>
                        <button class="day-btn time-btn w-full p-3 border border-slate-200 rounded-xl outline-none text-sm" data-day="Mer" onclick="app.toggleDaySelection('Mer', this)">M</button>
                        <button class="day-btn time-btn w-full p-3 border border-slate-200 rounded-xl outline-none text-sm" data-day="Gio" onclick="app.toggleDaySelection('Gio', this)">G</button>
                        <button class="day-btn time-btn w-full p-3 border border-slate-200 rounded-xl outline-none text-sm" data-day="Ven" onclick="app.toggleDaySelection('Ven', this)">V</button>
                        <button class="day-btn time-btn w-full p-3 border border-slate-200 rounded-xl outline-none text-sm" data-day="Sab" onclick="app.toggleDaySelection('Sab', this)">S</button>
                        <button class="day-btn time-btn w-full p-3 border border-slate-200 rounded-xl outline-none text-sm" data-day="Dom" onclick="app.toggleDaySelection('Dom', this)">D</button>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2 text-center">Nessun giorno selezionato = Tutti i giorni</p>
                </div>
            </div>

            <input type="hidden" id="input-med-edit-id">
            <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                <button onclick="app.closeModal('modal-med')" class="px-5 py-2.5 text-slate-500 font-bold hover:bg-slate-200 rounded-xl transition-colors">Chiudi</button>
                <button onclick="app.handleMedicationSubmit()" class="px-8 py-2.5 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700 transition-transform active:scale-95">Salva</button>
            </div>
        </div>
    </div>

    <!-- UI SCANNER -->
    <div id="camera-container">
        <video id="camera-feed" autoplay playsinline></video>
        <canvas id="camera-canvas" class="hidden"></canvas>
        <div class="scanner-overlay">
            <div class="scanner-frame">
                <div class="scanner-line"></div>
            </div>
        </div>
        <div class="absolute bottom-10 left-0 right-0 flex justify-center items-center gap-10">
            <button onclick="app.stopScanner()" class="w-12 h-12 rounded-full bg-white/20 text-white text-xl flex items-center justify-center">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <button onclick="app.captureImage()" class="w-20 h-20 rounded-full border-4 border-white bg-blue-600 flex items-center justify-center shadow-lg active:scale-90 transition-transform">
                <i class="fa-solid fa-camera text-3xl text-white"></i>
            </button>
            <div class="w-12"></div> <!-- Spacer -->
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mb-4"></div>
        <p id="loading-text" class="font-bold">Analisi in corso...</p>
    </div>

    <script>
        const app = {
            data: { lastOpened: null, profiles: [], apiKey: "" },
            currentProfileId: null,
            selectedTimes: [],
            selectedDays: [],
            currentTherapyMonth: null,
            therapyMonthSwipeInitialized: false,
            currentEditingMed: null,
            touchStartX: 0,
            touchStartY: 0,
            isSwiping: false,
            stream: null,
            newProfileAvatar: null,
            expandedSections: [],
            confirmCallback: null,
            
            // Variabili per il modale dettagli giorno
            editingDayDate: null, 
            editingDayTimes: [],

            // ðŸŽ¨ TEMI DI COLORE
            profileThemes: [
                { bg: 'bg-blue-50', border: 'border-blue-200', iconBg: 'bg-blue-100', iconText: 'text-blue-600', progress: 'text-blue-500' },
                { bg: 'bg-emerald-50', border: 'border-emerald-200', iconBg: 'bg-emerald-100', iconText: 'text-emerald-600', progress: 'text-emerald-500' },
                { bg: 'bg-violet-50', border: 'border-violet-200', iconBg: 'bg-violet-100', iconText: 'text-violet-600', progress: 'text-violet-500' },
                { bg: 'bg-amber-50', border: 'border-amber-200', iconBg: 'bg-amber-100', iconText: 'text-amber-600', progress: 'text-amber-500' },
                { bg: 'bg-rose-50', border: 'border-rose-200', iconBg: 'bg-rose-100', iconText: 'text-rose-600', progress: 'text-rose-500' },
                { bg: 'bg-cyan-50', border: 'border-cyan-200', iconBg: 'bg-cyan-100', iconText: 'text-cyan-600', progress: 'text-cyan-500' },
                { bg: 'bg-fuchsia-50', border: 'border-fuchsia-200', iconBg: 'bg-fuchsia-100', iconText: 'text-fuchsia-600', progress: 'text-fuchsia-500' },
                { bg: 'bg-lime-50', border: 'border-lime-200', iconBg: 'bg-lime-100', iconText: 'text-lime-600', progress: 'text-lime-500' },
            ],

            init() {
                this.loadData();
                this.checkDailyReset();
                this.renderProfiles();
                this.setupManifest();
                const usage = document.getElementById('input-med-usage');
                if (usage) {
                    usage.addEventListener('input', () => {
                        usage.style.height = 'auto';
                        usage.style.height = usage.scrollHeight + 'px';
                    });
                }
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('current-date-display').textContent = new Date().toLocaleDateString('it-IT', options);

                document.getElementById('btn-back').addEventListener('click', () => this.goBack());

                document.addEventListener('touchstart', e => {
                    this.touchStartX = e.changedTouches[0].screenX;
                    this.touchStartY = e.changedTouches[0].screenY;
                    this.isSwiping = false;
                }, { passive: true });

                document.addEventListener('touchend', e => {
                    const touchEndX = e.changedTouches[0].screenX;
                    const touchEndY = e.changedTouches[0].screenY;
                    this.handleSwipe(touchEndX, touchEndY);
                }, { passive: true });

                // Bind confirm button only once
                document.getElementById('confirm-btn-yes').addEventListener('click', () => {
                    if (this.confirmCallback) {
                        this.confirmCallback();
                    }
                    this.closeModal('modal-confirm');
                });

                // â±ï¸ Controllo automatico cambio giorno
                setInterval(() => {
                    // Controlla se siamo in una vista profilo prima di renderizzare
                    if (this.currentProfileId) {
                        this.renderMedications();
                    }
                }, 60 * 1000);
            },
            
            // --- GESTIONE MODALI DI SISTEMA ---
            showAlert(title, message) {
                document.getElementById('alert-title').textContent = title;
                document.getElementById('alert-message').textContent = message;
                this.showModal('modal-alert');
            },

            showConfirm(title, message, onConfirm) {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                this.confirmCallback = onConfirm;
                this.showModal('modal-confirm');
            },
            
            // --- GESTIONE MODALE FREQUENZA ---
            openFrequencyModal() {
                const currentVal = document.getElementById('med-frequency').value || 'daily';
                
                // Aggiorna UI nel modale
                document.querySelectorAll('.freq-option').forEach(btn => {
                    if (btn.dataset.val === currentVal) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
                
                this.showModal('modal-frequency');
            },
            
            selectFrequency(val) {
                document.getElementById('med-frequency').value = val;
                
                // Aggiorna Display nel form
                const displayTxt = document.getElementById('freq-text-display');
                const displayIcon = document.getElementById('freq-icon-display');
                
                if (val === 'daily') {
                    displayTxt.textContent = "Ogni Giorno";
                    displayIcon.className = "fa-solid fa-calendar-day text-blue-500";
                } else {
                    displayTxt.textContent = "Giorni Alterni";
                    displayIcon.className = "fa-solid fa-calendar-days text-orange-500";
                }
                
                // Aggiorna anteprime se necessario
                const startDate = document.getElementById('med-start-date')?.value || null;
                const durationDays = parseInt(document.getElementById('med-duration')?.value) || null;
                if(startDate) {
                    this.renderTherapyPreview({ startDate, durationDays, frequency: val });
                }
                
                this.closeModal('modal-frequency');
            },

            initTherapyMonthSwipe() {
                if (this.therapyMonthSwipeInitialized) return;

                const el = document.getElementById('therapy-month-wrapper');
                if (!el) return;

                let startX = 0;

                el.addEventListener('touchstart', e => {
                    startX = e.touches[0].clientX;
                }, { passive: true });

                el.addEventListener('touchend', e => {
                    const endX = e.changedTouches[0].clientX;
                    const diff = endX - startX;

                    if (Math.abs(diff) < 40) return;

                    if (diff > 0) {
                        this.goToPrevTherapyMonth();
                    } else {
                        this.goToNextTherapyMonth();
                    }
                });

                this.therapyMonthSwipeInitialized = true;
            },

            normalizeDate(date) {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                return d;
            },

            parseLocalDate(iso) {
                const [y, m, d] = iso.split('-').map(Number);
                return new Date(y, m - 1, d);
            },
            
            // --- GESTIONE DETTAGLIO GIORNO (OVERRIDE) ---
            
            openDayDetail(dateIso) {
                this.editingDayDate = dateIso;
                this.editingDayTimes = []; // Reset

                // 1. Cerca il farmaco attuale (o i suoi fratelli per sharedId)
                if (!this.currentEditingMed) return;
                
                // Formatta data per titolo
                const dateObj = this.parseLocalDate(dateIso);
                const options = { weekday: 'long', day: 'numeric', month: 'long' };
                document.getElementById('day-detail-date').textContent = dateObj.toLocaleDateString('it-IT', options);

                // 2. Verifica se esiste giÃ  un override per questa data
                const specificDays = this.currentEditingMed.specificDays || {};
                
                if (specificDays[dateIso]) {
                    // Se esiste un override, usa quello
                    this.editingDayTimes = [...specificDays[dateIso]];
                } else {
                    // Se non esiste, determina quali sarebbero gli orari standard attivi per oggi
                    // Controlla la frequenza generale
                    const isStandardActive = this.isMedicationDay(this.currentEditingMed, dateIso, true); // true = ignora override
                    
                    if (isStandardActive) {
                        // Se il giorno Ã¨ attivo secondo la frequenza, prendi tutti gli orari configurati per questo farmaco
                        // Dobbiamo cercare tutti i meds con lo stesso sharedId nel profilo
                        const profile = this.data.profiles.find(p => p.id === this.currentProfileId);
                        if (profile) {
                            const siblings = profile.meds.filter(m => m.sharedId === this.currentEditingMed.sharedId);
                            this.editingDayTimes = siblings.map(m => m.time);
                        } else {
                            // Fallback se stiamo creando un nuovo profilo e non Ã¨ ancora salvato (raro qui perchÃ© il calendario appare in edit)
                             this.editingDayTimes = [...this.selectedTimes];
                        }
                    } else {
                         // Giorno normalmente inattivo -> nessun orario selezionato di default
                        this.editingDayTimes = [];
                    }
                }
                
                this.updateDayDetailUI();
                this.showModal('modal-day-detail');
            },
            
            toggleDayDetailTime(time) {
                const idx = this.editingDayTimes.indexOf(time);
                if (idx > -1) {
                    this.editingDayTimes.splice(idx, 1);
                } else {
                    this.editingDayTimes.push(time);
                }
                this.updateDayDetailUI();
            },
            
            updateDayDetailUI() {
                document.querySelectorAll('.detail-time-btn').forEach(btn => {
                    const val = btn.dataset.val;
                    if (this.editingDayTimes.includes(val)) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            },
            
            saveDayDetail() {
                if (!this.currentEditingMed || !this.editingDayDate) return;
                
                // Salva temporaneamente l'override nell'oggetto corrente
                // Nota: questo viene salvato definitivamente solo quando si clicca "Salva" nel modale farmaco principale
                // Ma per la UI live del calendario, dobbiamo aggiornarlo subito in memoria
                
                if (!this.currentEditingMed.specificDays) {
                    this.currentEditingMed.specificDays = {};
                }
                
                this.currentEditingMed.specificDays[this.editingDayDate] = [...this.editingDayTimes];
                
                // Aggiorna il calendario mensile
                this.renderTherapyMonth(this.currentEditingMed);
                this.closeModal('modal-day-detail');
            },

            updateTherapyStatusUI(med) {
                const box = document.getElementById('therapy-status-box');
                const badge = document.getElementById('therapy-badge');
                const countdown = document.getElementById('therapy-countdown');

                if (!med || !med.endDate || !med.startDate) {
                    box.classList.add('hidden');
                    return;
                }

                // Usa la logica centralizzata per la coerenza
                const countdownData = this.calculateTherapyCountdown(med);

                box.classList.remove('hidden');
                box.className = "p-3 rounded-xl border mt-3 text-sm flex items-center gap-3";

                if (countdownData.phase === 'not-started') {
                    badge.textContent = "â³ Non iniziata";
                    badge.className = "bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold";
                    countdown.textContent = `Inizia tra ${countdownData.days}g`;
                    box.classList.add("bg-blue-50", "border-blue-200");
                }
                else if (countdownData.phase === 'ended') {
                    badge.textContent = "âœ… Terminata";
                    badge.className = "bg-slate-100 text-slate-700 px-3 py-1 rounded-full text-xs font-bold";
                    countdown.textContent = `Terminata`;
                    box.classList.add("bg-slate-50", "border-slate-200");
                }
                else {
                    // Fase Attiva
                    const diff = countdownData.days;
                    if (diff <= 3) {
                        badge.textContent = "â–¶ï¸ In scadenza";
                        badge.className = "bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-bold";
                        countdown.textContent = `Scade tra ${diff} giorni`;
                        box.classList.add("bg-orange-50", "border-orange-200");
                    } else {
                        badge.textContent = "â–¶ï¸ In corso";
                        badge.className = "bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full text-xs font-bold";
                        countdown.textContent = `Restano ${diff} giorni`;
                        box.classList.add("bg-emerald-50", "border-emerald-200");
                    }
                }
            },

            calculateEndDate(startDate, durationDays, frequency) {
                if (!startDate || !durationDays) return null;

                const start = new Date(startDate);

                // Caso giornaliero
                if (frequency !== "alternate") {
                    const end = new Date(start);
                    end.setDate(start.getDate() + durationDays - 1);
                    return end.toISOString().slice(0, 10);
                }

                // Caso giorni alterni â†’ durata = numero di dosi
                let doses = 0;
                let offset = 0;

                while (doses < durationDays) {
                    const d = new Date(start);
                    d.setDate(start.getDate() + offset);

                    if (offset % 2 === 0) {
                        doses++;
                    }

                    offset++;
                }

                const end = new Date(start);
                end.setDate(start.getDate() + offset - 1);
                return end.toISOString().slice(0, 10);
            },

            calculateTherapyCountdown(med) {
                if (!med.startDate || !med.endDate) return null;

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const start = new Date(med.startDate);
                start.setHours(0, 0, 0, 0);

                const end = new Date(med.endDate);
                end.setHours(0, 0, 0, 0);

                // Se non Ã¨ ancora iniziata
                if (today < start) {
                    const daysToStart = Math.ceil((start - today) / 86400000);
                    return {
                        phase: 'not-started',
                        days: daysToStart
                    };
                }

                // Se Ã¨ terminata
                if (today > end) {
                    return {
                        phase: 'ended',
                        days: 0
                    };
                }

                // In corso
                const daysLeft = Math.ceil((end - today) / 86400000);
                return {
                    phase: 'active',
                    days: daysLeft
                };
            },

            isMedicationDay(med, dateISO, ignoreOverride = false) {
                // 1. Controllo Override specifico per la data
                if (!ignoreOverride && med.specificDays && med.specificDays[dateISO] !== undefined) {
                    // Se esiste un override, controlla se l'orario del farmaco Ã¨ incluso nell'array
                    return med.specificDays[dateISO].includes(med.time);
                }

                // 2. Logica Standard
                if (!med.startDate) return true;
                
                // Se Ã¨ fuori dal range temporale standard, Ã¨ falso (a meno che non ci fosse un override positivo sopra)
                if (med.endDate && dateISO > med.endDate) return false;
                if (dateISO < med.startDate) return false;

                if (med.frequency !== "alternate") return true;

                const start = new Date(med.startDate);
                const today = new Date(dateISO);

                const diffDays = Math.floor(
                    (today - start) / (1000 * 60 * 60 * 24)
                );

                return diffDays % 2 === 0;
            },

            getTherapyDayInfo(med, dateISO) {
                if (!med.startDate || !med.durationDays) {
                    return { active: false, activeTimes: [] };
                }

                // PRENDI LE TIMES STANDARD DAL MODALE CORRENTE (ANTEPRIMA)
                // Usiamo this.selectedTimes che Ã¨ live nel modale di editing
                const standardTimes = this.selectedTimes || [];

                const start = new Date(med.startDate);
                const target = new Date(dateISO);

                // se prima dell'inizio terapia â†’ fuori
                if (target < start) {
                    return { active: false, activeTimes: [] };
                }
                
                // Verifica override
                let hasOverride = false;
                let isOverrideActive = false;
                let overrideTimes = [];
                
                if (med.specificDays && med.specificDays[dateISO] !== undefined) {
                    hasOverride = true;
                    overrideTimes = med.specificDays[dateISO];
                    // Se l'array non Ã¨ vuoto, consideriamo il giorno attivo visivamente nel calendario
                    isOverrideActive = overrideTimes.length > 0;
                }

                let dosesCount = 0;
                let current = new Date(start);

                // Per il conteggio dosi, usiamo la logica standard
                // Ma per dire se Ã¨ "active" nel calendario usiamo anche l'override
                
                while (dosesCount < med.durationDays) {
                    const iso = current.toISOString().slice(0, 10);
                    // Qui usiamo true per ignorare l'override nel calcolo della sequenza teorica
                    const isActiveStandard = this.isMedicationDay(med, iso, true);

                    if (isActiveStandard) {
                        dosesCount++;

                        if (iso === dateISO) {
                            // SE GIORNO STANDARD ATTIVO
                            if (hasOverride) {
                                return {
                                    active: isOverrideActive,
                                    activeTimes: overrideTimes,
                                    index: dosesCount,
                                    isFirst: dosesCount === 1,
                                    isLast: dosesCount === med.durationDays,
                                    hasOverride: hasOverride
                                };
                            } else {
                                return {
                                    active: true,
                                    activeTimes: standardTimes, // Usa le times standard
                                    index: dosesCount,
                                    isFirst: dosesCount === 1,
                                    isLast: dosesCount === med.durationDays,
                                    hasOverride: false
                                };
                            }
                        }
                    }

                    current.setDate(current.getDate() + 1);
                }
                
                // Se siamo qui, non Ã¨ un giorno standard della terapia. 
                // Ma potrebbe avere un override positivo (aggiunto extra)
                if (hasOverride && isOverrideActive) {
                     return {
                        active: true,
                        activeTimes: overrideTimes,
                        index: -1, // Extra
                        isFirst: false,
                        isLast: false,
                        hasOverride: true
                    };
                }

                return { active: false, activeTimes: [] };
            },

            getTherapyStatus(med) {
                if (!med.endDate) return null;
                const countdown = this.calculateTherapyCountdown(med);

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const end = new Date(med.endDate);
                end.setHours(0, 0, 0, 0);

                // âž• +1 per includere il giorno finale
                const diffDays = Math.ceil((end - today) / 86400000);

                if (countdown.phase === 'not-started') {
                    return {
                        cls: 'blue',
                        label: 'â³ Non iniziata',
                        sub: `Inizia tra ${countdown.days}g`
                    };
                }

                if (countdown.phase === 'active') {
                    if (countdown.days <= 2) {
                        return {
                            cls: 'orange',
                            label: 'â–¶ï¸ In scadenza',
                            sub: `Scade tra ${countdown.days}g`
                        };
                    }
                    return {
                        cls: 'green',
                        label: 'â–¶ï¸ In corso',
                        sub: `Restano ${countdown.days}g`
                    };
                }

                if (countdown.phase === 'ended') {
                    return {
                        cls: 'gray',
                        label: 'âœ… Terminata',
                        sub: 'Completata'
                    };
                }

                return {
                    label: "In corso",
                    sub: `Restano ${diffDays} giorni`,
                    cls: "green"
                };
            },

            renderTherapyPreview(med) {
                const container = document.getElementById('therapy-calendar');
                const wrapper = document.getElementById('therapy-preview');
                const legend = document.getElementById('therapy-legend');
                const monthWrapper = document.getElementById('therapy-month-wrapper');

                if (container) container.innerHTML = '';
                if (wrapper) wrapper.classList.add('hidden');
                if (legend) legend.classList.add('hidden');
                if (monthWrapper) monthWrapper.classList.add('hidden');

                if (
                    !med ||
                    !med.startDate ||
                    !med.durationDays ||
                    med.durationDays <= 0
                ) {
                    this.currentTherapyMonth = null;
                    return;
                }

                wrapper.classList.remove('hidden');

                const start = new Date(med.startDate);
                const totalDoses = med.durationDays;

                if (med.frequency === "alternate") {
                    legend.classList.remove('hidden');
                }

                let dosesCount = 0;
                let dayOffset = 0;

                while (dosesCount < totalDoses) {
                    const d = new Date(start);
                    d.setDate(start.getDate() + dayOffset);
                    const iso = d.toISOString().slice(0, 10);

                    // Qui usiamo standard logic per la preview orizzontale
                    const isActiveDay = this.isMedicationDay(med, iso, true);

                    if (isActiveDay) {
                        dosesCount++;

                        let cls = 'bg-yellow-400 text-slate-900';

                        if (dosesCount === 1) {
                            cls = 'bg-green-600 text-white';
                        } else if (dosesCount === totalDoses) {
                            cls = 'bg-red-600 text-white';
                        }

                        const el = document.createElement('div');
                        el.className = `w-9 h-9 flex-shrink-0 rounded-full flex items-center justify-center text-xs font-bold ${cls}`;
                        el.textContent = d.getDate();
                        container.appendChild(el);
                    }

                    dayOffset++;
                }

                if (med.startDate && med.durationDays && med.endDate) {
                    this.renderTherapyMonth(med);
                }
            },

            renderTherapyMonth(med) {
                if (!med || !med.startDate || !med.endDate) {
                    return;
                }
                const wrapper = document.getElementById('therapy-month-wrapper');
                const container = document.getElementById('therapy-month');

                if (!wrapper || !container) return;

                container.innerHTML = '';

                if (!med || !med.startDate || !med.endDate) {
                    wrapper.classList.add('hidden');
                    return;
                }

                wrapper.classList.remove('hidden');

                if (!this.currentTherapyMonth) {
                    this.currentTherapyMonth = this.parseLocalDate(med.startDate);
                }

                const start = new Date(this.currentTherapyMonth);

                const header = document.getElementById('therapy-month-header');

                const monthNames = [
                    'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                    'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'
                ];

                if (header) {
                    header.textContent = `${monthNames[start.getMonth()]} ${start.getFullYear()}`;
                }
                const base = new Date(start);
                base.setDate(1);

                const month = base.getMonth();
                const year = base.getFullYear();

                const firstDay = new Date(year, month, 1).getDay();
                // Fix per far iniziare la settimana da LunedÃ¬ (0=Lun in array visuale, ma getDay() 0=Dom)
                const firstDayAdjusted = firstDay === 0 ? 6 : firstDay - 1;
                
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // Spazi vuoti prima
                for (let i = 0; i < firstDayAdjusted; i++) {
                    container.appendChild(document.createElement('div'));
                }

                for (let d = 1; d <= daysInMonth; d++) {
                    const date = new Date(year, month, d);

                    const iso = [
                        date.getFullYear(),
                        String(date.getMonth() + 1).padStart(2, '0'),
                        String(date.getDate()).padStart(2, '0')
                    ].join('-');

                    const info = this.getTherapyDayInfo(med, iso);

                    // MODIFICA: Calcolo se il giorno Ã¨ nel range della terapia
                    let isWithinRange = false;
                    if (med.startDate && med.endDate) {
                        isWithinRange = (iso >= med.startDate && iso <= med.endDate);
                    }

                    // Il giorno Ã¨ cliccabile se Ã¨ attivo (ha farmaci) O se Ã¨ nel periodo della terapia (anche se spento/grigio)
                    const isInteractable = info.active || isWithinRange;

                    let cls = 'therapy-day ';

                    if (info.active) {
                        cls += 'clickable-day '; // Questo ha l'hover effect
                        if (info.isFirst) {
                            cls += 'therapy-start';
                        } else if (info.isLast) {
                            cls += 'therapy-end';
                        } else {
                            cls += 'therapy-mid';
                        }
                        
                        if(info.hasOverride) {
                           cls += ' border-2 border-blue-500';
                        }
                    } else {
                        cls += 'therapy-out';
                    }
                    
                    // Se Ã¨ interagibile ma spento (grigio), forziamo il cursore pointer
                    if (isInteractable && !info.active) {
                        cls += ' cursor-pointer hover:brightness-95'; 
                    }

                    const el = document.createElement('div');
                    el.className = cls;
                    
                    // Numero Giorno
                    const spanNum = document.createElement('span');
                    spanNum.textContent = d;
                    el.appendChild(spanNum);
                    
                    // ICONE ORARI (Solo se attivo)
                    if (info.active && info.activeTimes && info.activeTimes.length > 0) {
                        const iconContainer = document.createElement('div');
                        iconContainer.className = 'cal-icon-wrapper';
                        
                        // Ordine fisso: Mattina, Pomeriggio, Sera
                        const order = ['Mattina', 'Pomeriggio', 'Sera'];
                        const sortedTimes = info.activeTimes.sort((a,b) => order.indexOf(a) - order.indexOf(b));
                        
                        sortedTimes.forEach(t => {
                            const i = document.createElement('i');
                            if (t === 'Mattina') i.className = 'fa-solid fa-sun text-[10px] text-orange-600';
                            if (t === 'Pomeriggio') i.className = 'fa-solid fa-cloud-sun text-[10px] text-blue-500';
                            if (t === 'Sera') i.className = 'fa-solid fa-moon text-[10px] text-indigo-800';

                            if (info.hasOverride) {
                                i.classList.add('text-[11px]');
                            }

                            iconContainer.appendChild(i);
                        });
                        el.appendChild(iconContainer);
                    }
                    
                    // MODIFICA: Aggiungi click handler se Ã¨ interagibile
                    if (isInteractable) {
                        el.onclick = () => this.openDayDetail(iso);
                    }

                    container.appendChild(el);
                }
            },

            goToPrevTherapyMonth() {
                this.currentTherapyMonth = new Date(
                    this.currentTherapyMonth.getFullYear(),
                    this.currentTherapyMonth.getMonth() - 1,
                    1
                );
                this.renderTherapyMonth(this.currentEditingMed);
            },

            goToNextTherapyMonth() {
                this.currentTherapyMonth = new Date(
                    this.currentTherapyMonth.getFullYear(),
                    this.currentTherapyMonth.getMonth() + 1,
                    1
                );
                this.renderTherapyMonth(this.currentEditingMed);
            },

            checkTherapyEnd(profile) {
                if (!profile) return;

                const today = new Date().toISOString().slice(0, 10);
                const alertedSharedIds = new Set();
                let endedMeds = [];

                profile.meds.forEach(med => {

                    if (!med.endDate) return;
                    if (med.therapyEndedAlertShown) return;
                    if (alertedSharedIds.has(med.sharedId)) return;

                    if (today >= med.endDate) {
                        endedMeds.push(med.name);
                        alertedSharedIds.add(med.sharedId);

                        profile.meds.forEach(m => {
                            if (m.sharedId === med.sharedId) {
                                m.therapyEndedAlertShown = true;
                            }
                        });
                    }
                });
                
                if (endedMeds.length > 0) {
                     this.showAlert(
                        "Terapie Terminate", 
                        `I seguenti farmaci hanno terminato il periodo di terapia:\n${endedMeds.join(', ')}`
                    );
                }

                this.saveData();
            },

            parseDose(dose) {
                if (!dose) return 1;

                if (typeof dose === "string") {
                    const frac = dose.match(/(\d+)\s*\/\s*(\d+)/);
                    if (frac) {
                        return parseInt(frac[1]) / parseInt(frac[2]);
                    }

                    const num = parseFloat(dose.replace(",", "."));
                    if (!isNaN(num)) return num;
                }

                return 1;
            },
            
            // Refactor: Collect all low stock alerts
            checkDailyReset() {
                const today = new Date().toISOString().slice(0, 10);

                if (this.data.lastOpened === today) return;

                let lowStockMeds = [];

                this.data.profiles.forEach(profile => {
                    profile.meds.forEach(med => {
                        if (med.taken) {
                            const doseQty = this.parseDose(med.dose);
                            med.boxQty = Math.max(0, med.boxQty - doseQty);
                        }
                        if (med.boxQty > med.minQty) {
                            med.alertShown = false;
                        }
                        if (
                            med.minQty > 0 &&
                            med.boxQty <= med.minQty &&
                            med.alertShown === false
                        ) {
                            lowStockMeds.push(`${med.name} (${med.boxQty} rimasti)`);
                            med.alertShown = true;
                        }
                        med.taken = false;
                    });
                });
                
                if (lowStockMeds.length > 0) {
                    this.showAlert(
                        "Scorte in esaurimento", 
                        `I seguenti farmaci sono sotto la soglia minima:\n\n${lowStockMeds.join('\n')}`
                    );
                }

                this.data.lastOpened = today;
                this.saveData();
            },

            toggleDaySelection(day, btn) {
                const idx = this.selectedDays.indexOf(day);
                idx > -1 ? this.selectedDays.splice(idx, 1) : this.selectedDays.push(day);
                this.updateDayUI();
            },

            updateDayUI() {
                if (!this.selectedDays) this.selectedDays = [];
                document.querySelectorAll('.day-btn').forEach(b => {
                    const day = b.dataset.day;
                    this.selectedDays.includes(day)
                        ? b.classList.add('selected')
                        : b.classList.remove('selected');
                });
            },

            // --- CAMERA SCANNER LOGIC ---

            async startScanner() {
                const container = document.getElementById('camera-container');
                const video = document.getElementById('camera-feed');

                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: { ideal: "environment" },
                            width: { ideal: 1920 },
                            height: { ideal: 1080 },
                            focusMode: { ideal: "continuous" }
                        }
                    });
                    video.srcObject = this.stream;
                    container.style.display = 'flex';
                } catch (err) {
                    this.showAlert("Errore", "Impossibile accedere alla fotocamera. Verifica i permessi.");
                }
            },

            stopScanner() {
                const container = document.getElementById('camera-container');
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }
                container.style.display = 'none';
            },

            async captureImage() {
                const video = document.getElementById('camera-feed');
                const canvas = document.getElementById('camera-canvas');
                const ctx = canvas.getContext('2d');

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.filter = "contrast(1.15) brightness(1.05) saturate(1.1)";
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                ctx.filter = "none";

                const base64Data = canvas.toDataURL('image/jpeg', 0.95).split(',')[1];
                this.stopScanner();
                await this.analyzeImage(base64Data);
            },

            async analyzeImage(base64Image) {
                if (!this.data.apiKey) {
                    this.showAlert("Attenzione", "Vai nelle Impostazioni e inserisci la tua API Key per attivare il riconoscimento.");
                    return;
                }

                this.toggleLoading(true, "Analisi farmaco...");

                const prompt = `Analizza questa immagine di un farmaco. Restituisci un oggetto JSON con questi campi precisi:
                            - 'name': il nome commerciale seguito dalla concentrazione (es. 'Pantoprazolo Teva 40mg').
                            - 'category': la forma farmaceutica o categoria (es. 'compresse gastroresistenti', 'bustine', 'sciroppo').
                            - 'dose': lascia questo campo vuoto (stringa vuota "").
                            - 'usage': a cosa serve il farmaco (es. 'Trattamento ulcere').
                            Rispondi solo con il JSON.`;

                const payload = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: "image/png", data: base64Image } }
                        ]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                name: { type: "STRING" },
                                category: { type: "STRING" },
                                dose: { type: "STRING" },
                                usage: { type: "STRING" }
                            }
                        }
                    }
                };

                try {
                    const result = await this.fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${this.data.apiKey}`, payload);

                    let text = result.candidates[0].content.parts[0].text;
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();

                    const parsedData = JSON.parse(text);

                    if (parsedData.name) {
                        document.getElementById('input-med-name').value = parsedData.name;
                        document.getElementById('input-med-category').value = parsedData.category || "";
                        document.getElementById('input-med-dose').value = parsedData.dose || "";
                        document.getElementById('input-med-usage').value = parsedData.usage || "";
                    } else {
                         this.showAlert("Mi dispiace", "Non ho riconosciuto il farmaco. Prova a inserirlo manualmente.");
                    }
                } catch (err) {
                    console.error(err);
                     this.showAlert("Errore", "Errore durante l'analisi. Verifica la tua API Key.");
                } finally {
                    this.toggleLoading(false);
                }
            },

            async fetchWithRetry(url, payload, retries = 5) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) return await response.json();
                    } catch (e) { }
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
                throw new Error("API fallita");
            },

            toggleLoading(show, text = "") {
                const overlay = document.getElementById('loading-overlay');
                const loadingText = document.getElementById('loading-text');
                loadingText.textContent = text;
                overlay.style.display = show ? 'flex' : 'none';
            },

            // --- NAVIGATION ---

            goBack() {
                this.goHome();
            },

            goHome() {
                this.currentProfileId = null;
                document.getElementById('view-profiles').classList.remove('hidden');
                document.getElementById('view-medications').classList.add('hidden');
                document.getElementById('view-settings').classList.add('hidden');
                document.getElementById('btn-back').classList.add('hidden');
                this.renderProfiles();
            },

            showSettings() {
                this.currentProfileId = null;
                document.getElementById('view-profiles').classList.add('hidden');
                document.getElementById('view-medications').classList.add('hidden');
                document.getElementById('view-settings').classList.remove('hidden');
                document.getElementById('btn-back').classList.remove('hidden');
                document.getElementById('input-settings-apikey').value = this.data.apiKey || "";
            },

            saveSettings() {
                this.data.apiKey = document.getElementById('input-settings-apikey').value.trim();
                this.saveData();
                this.showAlert("Successo", "Impostazioni salvate!");
            },

            resetAllData() {
                this.showConfirm(
                    "Attenzione", 
                    "Sei sicuro di voler resettare tutto? Tutti i dati andranno persi.", 
                    () => {
                        this.resetData();
                        this.goHome();
                    }
                );
            },

            // --- DATA LOGIC ---
            loadData() {
                const stored = localStorage.getItem('MedicineProData');

                if (!stored) {
                    this.resetData();
                    return;
                }

                try {
                    this.data = JSON.parse(stored);

                    if (!this.data.apiKey) this.data.apiKey = "";

                    // ðŸ”¹ RETROCOMPATIBILITÃ€ FARMACI
                    this.data.profiles.forEach((profile, index) => {

                        if (typeof profile.themeIndex === 'undefined') {
                            profile.themeIndex = index % this.profileThemes.length;
                        }

                        this.normalizeMedications(profile);

                        profile.meds.forEach(med => {

                            if (!Array.isArray(med.days)) med.days = [];
                            if (typeof med.boxQty !== "number") med.boxQty = 0;
                            if (typeof med.minQty !== "number") med.minQty = 0;
                            if (typeof med.alertShown !== "boolean") med.alertShown = false;
                            if (typeof med.taken !== "boolean") med.taken = false;
                            if (med.startDate === undefined) med.startDate = null;
                            if (med.durationDays === undefined) med.durationDays = null;
                            if (med.endDate === undefined) med.endDate = null;
                            if (typeof med.therapyEndedAlertShown !== "boolean") { med.therapyEndedAlertShown = false; }
                            if (!med.frequency) med.frequency = "daily";
                            if (!med.specificDays) med.specificDays = {}; // Nuovo campo per le eccezioni
                        });
                    });

                } catch (e) {
                    console.error("Errore caricamento dati", e);
                    this.resetData();
                }
            },

            resetData() {
                this.data = {
                    lastOpened: new Date().toISOString().slice(0, 10),
                    profiles: [],
                    apiKey: ""
                };
                this.saveData();
            },

            saveData() { localStorage.setItem('MedicineProData', JSON.stringify(this.data)); },

            exportData() {
                const safeData = JSON.parse(JSON.stringify(this.data));
                safeData.apiKey = "";

                const blob = new Blob(
                    [JSON.stringify(safeData, null, 2)],
                    { type: "application/json" }
                );

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `MedicinePro_Backup_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
            },

            exportProfileTxt() {
                const profile = this.data.profiles.find(x => x.id === this.currentProfileId);
                if (!profile) return;
                let content = `TERAPIA: ${profile.name.toUpperCase()}\n`;
                content += `Esportata il: ${new Date().toLocaleDateString('it-IT')}\n`;
                content += `--------------------------------------------------\n\n`;
                const times = ['Mattina', 'Pomeriggio', 'Sera'];
                times.forEach(time => {
                    const meds = profile.meds.filter(m => m.time === time);
                    if (meds.length > 0) {
                        content += `[${time.toUpperCase()}]\n`;
                        meds.forEach(m => {
                            content += `- ${m.name}`;
                            if (m.category) content += ` (${m.category})`;
                            if (m.dose) content += ` | Dose: ${m.dose}`;
                            if (m.usage) content += ` | Uso: ${m.usage}`;
                            content += `\n`;
                        });
                        content += `\n`;
                    }
                });
                const blob = new Blob([content], { type: "text/plain" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Terapia_${profile.name.replace(/\s+/g, '_')}.txt`;
                a.click();
            },

            triggerImport() { document.getElementById('import-file').click(); },
            handleImport(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (json && Array.isArray(json.profiles)) {
                            this.currentProfileId = null;
                            document.getElementById('input-med-edit-id').value = '';

                            this.data = json;
                            this.saveData();
                            this.goHome();
                        }
                    } catch (err) { 
                        this.showAlert("Errore", "File non valido.");
                    }
                };
                reader.readAsText(file);
                input.value = '';
            },

            generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); },

            openProfile(id) {
                this.currentProfileId = id;
                const profile = this.data.profiles.find(x => x.id === id); 

                document.getElementById('view-profiles').classList.add('hidden');
                document.getElementById('view-medications').classList.remove('hidden');
                document.getElementById('btn-back').classList.remove('hidden');

                // Initialize expanded section based on time
                const hour = new Date().getHours();
                let activeTime = 'Mattina';
                if (hour >= 13) activeTime = 'Pomeriggio';
                if (hour >= 19) activeTime = 'Sera';
                this.expandedSections = [activeTime];

                this.renderMedications();
                if (profile) this.checkTherapyEnd(profile);
            },

            selectAvatar(type) {
                this.newProfileAvatar = type;
                document.querySelectorAll('.avatar-btn').forEach(btn => {
                    if (btn.dataset.avatar === type) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            },

            createProfile() {
                const name = document.getElementById('input-profile-name').value.trim();
                if (!name) return;

                const themeIndex = this.data.profiles.length % this.profileThemes.length;

                this.data.profiles.push({
                    id: this.generateId(),
                    name,
                    meds: [],
                    themeIndex,
                    avatar: this.newProfileAvatar
                });

                this.saveData();
                document.getElementById('input-profile-name').value = '';
                this.closeModal('modal-add-profile');
                this.renderProfiles();
            },

            openEditProfileModal() {
                const p = this.data.profiles.find(x => x.id === this.currentProfileId);
                if (p) {
                    document.getElementById('input-edit-profile-name').value = p.name;
                    this.showModal('modal-edit-profile');
                }
            },

            saveProfileName() {
                const newName = document.getElementById('input-edit-profile-name').value.trim();
                const p = this.data.profiles.find(x => x.id === this.currentProfileId);
                if (p && newName) { p.name = newName; this.saveData(); this.renderMedications(); this.closeModal('modal-edit-profile'); }
            },

            deleteCurrentProfile() {
                this.showConfirm("Elimina Profilo", "Eliminare definitivamente questo profilo?", () => {
                    this.data.profiles = this.data.profiles.filter(x => x.id !== this.currentProfileId);
                    this.saveData(); 
                    this.goHome();
                });
            },

            renderProfiles() {
                const container = document.getElementById('profiles-list');
                container.innerHTML = '';
                if (this.data.profiles.length === 0) {
                    container.innerHTML = `<p class="text-center text-slate-400 py-10">Nessun profilo presente.</p>`;
                    return;
                }

                const avatarIcons = {
                    'man': 'fa-person',
                    'woman': 'fa-person-dress',
                    'dog': 'fa-dog',
                    'cat': 'fa-cat'
                };

                this.data.profiles.forEach(p => {
                    if (typeof p.themeIndex === 'undefined') {
                        p.themeIndex = Math.floor(Math.random() * this.profileThemes.length);
                    }
                    const theme = this.profileThemes[p.themeIndex] || this.profileThemes[0];

                    const total = p.meds.length;
                    const taken = p.meds.filter(m => m.taken).length;
                    const perc = total === 0 ? 0 : Math.round((taken / total) * 100);

                    const div = document.createElement('div');
                    div.className = `${theme.bg} ${theme.border} p-4 rounded-xl card-shadow flex justify-between items-center cursor-pointer border hover:shadow-md transition-all`;
                    div.onclick = () => this.openProfile(p.id);

                    const percClass = perc === 100 ? 'text-green-600' : theme.progress;

                    let iconContent;
                    if (p.avatar && avatarIcons[p.avatar]) {
                        iconContent = `<i class="fa-solid ${avatarIcons[p.avatar]} text-xl"></i>`;
                    } else {
                        iconContent = p.name.charAt(0).toUpperCase();
                    }

                    div.innerHTML = `
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full ${theme.iconBg} ${theme.iconText} flex items-center justify-center font-bold shadow-sm border border-white/50">
                                            ${iconContent}
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-slate-800">${p.name}</h3>
                                            <p class="text-xs text-slate-500">${total} farmaci</p>
                                        </div>
                                    </div>
                                    <span class="text-sm font-bold ${percClass}">${perc}%</span>`;
                    container.appendChild(div);
                });
            },

            prepareNewMed() {
                document.getElementById('input-med-edit-id').value = '';
                this.currentEditingMed = null;
                this.resetMedModal();
                
                // Scroll to top
                const content = document.querySelector('#med-modal-content');
                if(content) content.scrollTop = 0;

                this.showModal('modal-med');
            },

            showModal(id) {
                if (id === 'modal-med') {
                    const editId = document.getElementById('input-med-edit-id').value;
                    if (!editId) {
                        this.resetMedModal();
                    }
                }

                if (id === 'modal-add-profile') {
                    this.selectAvatar(null);
                    this.newProfileAvatar = null;
                }

                document.getElementById(id).classList.remove('hidden');
            },

            resetMedModal() {
                document.getElementById('med-modal-title').textContent = "Nuovo Farmaco";
                document.getElementById('input-med-name').value = '';
                document.getElementById('input-med-category').value = '';
                document.getElementById('input-med-dose').value = '';
                document.getElementById('input-med-usage').value = '';
                
                // ADDED: Reset dei nuovi campi
                document.getElementById('med-box-qty').value = '';
                document.getElementById('med-min-qty').value = '';
                document.getElementById('med-start-date').value = '';
                document.getElementById('med-duration').value = '';
                
                // Reset Frequenza UI
                this.selectFrequency('daily');

                document.getElementById('btn-scan').classList.remove('hidden');
                document.getElementById('therapy-status-box').classList.add('hidden');
                document.getElementById('therapy-preview').classList.add('hidden');
                document.getElementById('therapy-month-wrapper').classList.add('hidden');

                this.selectedTimes = [];
                this.updateTimeUI();
                this.selectedDays = [];
                this.updateDayUI();
            },

            openEditMedModal(medId) {
                const profile = this.data.profiles.find(x => x.id === this.currentProfileId);
                const med = profile.meds.find(m => m.id === medId);
                if (med) {
                    document.getElementById('input-med-edit-id').value = med.id;
                    document.getElementById('input-med-name').value = med.name;
                    document.getElementById('input-med-category').value = med.category || "";
                    document.getElementById('input-med-dose').value = med.dose || "";
                    document.getElementById('input-med-usage').value = med.usage || "";
                    document.getElementById('med-box-qty').value = med.boxQty ?? 0;
                    document.getElementById('med-min-qty').value = med.minQty ?? 0;
                    
                    this.selectFrequency(med.frequency || "daily");
                    
                    document.getElementById('med-start-date').value = med.startDate || "";
                    document.getElementById('med-duration').value = med.durationDays ?? "";
                    document.getElementById('med-modal-title').textContent = "Modifica Farmaco";
                    document.getElementById('btn-scan').classList.add('hidden');
                    
                    const relatedMeds = profile.meds.filter(m => m.sharedId === med.sharedId);
                    this.selectedTimes = relatedMeds.map(m => m.time);
                    
                    this.selectedDays = Array.isArray(med.days) ? [...med.days] : [];
                    this.updateTherapyStatusUI(med);
                    this.renderTherapyPreview(med);
                    this.initTherapyMonthSwipe();

                    document.getElementById('modal-med').classList.remove('hidden');

                    this.updateTimeUI();
                    this.updateDayUI();

                    const start = this.parseLocalDate(med.startDate);
                    this.currentTherapyMonth = new Date(
                        start.getFullYear(),
                        start.getMonth(),
                        1
                    );

                    this.currentEditingMed = med;
                    // Re-renderizziamo il mese per aggiornare le classi clickable
                    this.renderTherapyMonth(med);
                }
            },

            handleMedicationSubmit() {
                const name = document.getElementById('input-med-name').value.trim();
                const category = document.getElementById('input-med-category').value.trim();
                const dose = document.getElementById('input-med-dose').value.trim();
                const usage = document.getElementById('input-med-usage').value.trim();
                const frequency = document.getElementById('med-frequency').value;
                const editId = document.getElementById('input-med-edit-id').value;
                const startDate = document.getElementById('med-start-date')?.value || null;
                const durationDays = parseInt(document.getElementById('med-duration')?.value) || null;
                const endDate = this.calculateEndDate(startDate, durationDays, frequency);

                const boxQty = parseFloat(document.getElementById('med-box-qty').value) || 0;
                const minQty = parseFloat(document.getElementById('med-min-qty').value) || 0;

                if (!name || this.selectedTimes.length === 0) {
                     this.showAlert("Dati mancanti", "Inserisci almeno il Nome e l'Orario.");
                     return;
                }

                const profile = this.data.profiles.find(x => x.id === this.currentProfileId);

                // =========================
                // âœï¸ MODIFICA FARMACO
                // =========================
                if (editId) {
                    const med = profile.meds.find(m => m.id === editId);
                    if (med) {
                        const sharedId = med.sharedId;
                        // PRESERVA LE ECCEZIONI: se stiamo modificando, manteniamo il calendario specifico
                        // Assumiamo che tutte le istanze abbiano le stesse eccezioni
                        const preservedSpecificDays = med.specificDays || {};

                        // 1. Aggiorna le proprietÃ  comuni
                        profile.meds.forEach(m => {
                            if (m.sharedId === sharedId) {
                                m.name = name;
                                m.category = category;
                                m.dose = dose;
                                m.usage = usage;
                                m.startDate = startDate;
                                m.durationDays = durationDays;
                                m.endDate = endDate;
                                m.days = Array.isArray(this.selectedDays) ? [...this.selectedDays] : [];
                                m.frequency = frequency; 
                                
                                const oldQty = m.boxQty;
                                m.boxQty = boxQty;
                                m.minQty = minQty;
                                
                                // Assicurati che l'oggetto abbia la proprietÃ 
                                m.specificDays = preservedSpecificDays;

                                if (boxQty > minQty && boxQty > oldQty) {
                                    m.alertShown = false;
                                }
                            }
                        });

                        // 2. Gestione degli orari (Aggiunta/Rimozione istanze)
                        const existingInstances = profile.meds.filter(m => m.sharedId === sharedId);
                        const existingTimes = existingInstances.map(m => m.time);

                        const timesToAdd = this.selectedTimes.filter(t => !existingTimes.includes(t));
                        const timesToRemove = existingTimes.filter(t => !this.selectedTimes.includes(t));

                        if (timesToRemove.length > 0) {
                             profile.meds = profile.meds.filter(m => !(m.sharedId === sharedId && timesToRemove.includes(m.time)));
                        }

                        timesToAdd.forEach(t => {
                             profile.meds.push({
                                id: this.generateId(),
                                sharedId: sharedId,
                                name,
                                category,
                                dose,
                                usage,
                                startDate,
                                durationDays,
                                endDate,
                                time: t,
                                days: Array.isArray(this.selectedDays) ? [...this.selectedDays] : [],
                                frequency,
                                taken: false,
                                boxQty,
                                minQty,
                                therapyEndedAlertShown: false,
                                alertShown: false,
                                specificDays: preservedSpecificDays // Importante propagare
                            });
                        });
                    }

                    // =========================
                    // âž• NUOVO FARMACO
                    // =========================
                } else {
                    const sharedId = this.generateId();

                    this.selectedTimes.forEach(t => {
                        profile.meds.push({
                            id: this.generateId(),
                            sharedId: sharedId,
                            name,
                            category,
                            dose,
                            usage,
                            startDate,
                            durationDays,
                            endDate,
                            time: t,
                            days: Array.isArray(this.selectedDays) ? [...this.selectedDays] : [],
                            frequency,
                            taken: false,
                            boxQty,
                            minQty,
                            therapyEndedAlertShown: false,
                            alertShown: false,
                            specificDays: {} // Inizializza vuoto
                        });
                    });
                }

                this.saveData();
                this.closeModal('modal-med');
                this.renderMedications();
                this.renderTherapyPreview({ startDate, frequency });
            },

            normalizeMedications(profile) {
                profile.meds.forEach(m => {
                    if (!m.sharedId) {
                        m.sharedId = m.id;
                    }
                });
            },

            toggleMedication(id) {
                const profile = this.data.profiles.find(p => p.id === this.currentProfileId);
                if (!profile) return;

                const med = profile.meds.find(m => m.id === id);
                if (!med) return;

                med.taken = !med.taken;

                this.saveData();
                this.renderMedications();
            },

            uncheckAllMeds() {
                const profile = this.data.profiles.find(x => x.id === this.currentProfileId);
                if (profile) {
                    this.showConfirm("Conferma", "Deselezionare tutto?", () => {
                        profile.meds.forEach(m => m.taken = false);
                        this.saveData(); this.renderMedications();
                    });
                }
            },

            deleteMedication(id) {
                this.showConfirm("Elimina Assunzione", "Eliminare questa assunzione?", () => {
                    const profile = this.data.profiles.find(x => x.id === this.currentProfileId);
                    profile.meds = profile.meds.filter(m => m.id !== id);
                    this.saveData(); this.renderMedications();
                });
            },

            showMedNote(medId) {
                const profile = this.data.profiles.find(x => x.id === this.currentProfileId);
                const med = profile.meds.find(m => m.id === medId);
                
                if (med && med.usage) {
                    document.getElementById('note-modal-title').textContent = med.name;
                    document.getElementById('note-modal-content').textContent = med.usage;
                    this.showModal('modal-show-note');
                }
            },

            renderMedications() {
                const profile = this.data.profiles.find(x => x.id === this.currentProfileId);
                if (!profile) return;
                document.getElementById('current-profile-name').textContent = profile.name;
                const times = ['Mattina', 'Pomeriggio', 'Sera'];
                let hasMeds = false;
                let anyTaken = false;

                const dayMap = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
                const todayShort = dayMap[new Date().getDay()];
                const todayISO = new Date().toISOString().slice(0, 10);

                times.forEach(time => {
                    const container = document.getElementById(`med-list-${time.toLowerCase()}`);
                    container.innerHTML = '';

                    const meds = profile.meds.filter(m => m.time === time);

                    if (meds.length > 0) {
                        hasMeds = true;

                        const totalCount = meds.length;
                        const takenCount = meds.filter(m => m.taken).length;
                        
                        // Logica Accordion: Usa lo stato persistente
                        const isOpen = this.expandedSections.includes(time);
                        const hiddenClass = isOpen ? '' : 'hidden';
                        const rotateClass = isOpen ? 'rotate-180' : '';

                        // Header Cliccabile
                        const header = document.createElement('div');
                        header.className = "cursor-pointer bg-white p-3 rounded-xl card-shadow border border-slate-100 mb-2 flex items-center justify-between transition-all hover:bg-slate-50";
                        header.onclick = () => this.toggleSection(time);
                        
                        let icon = time === 'Mattina' ? 'fa-sun text-orange-400' : (time === 'Pomeriggio' ? 'fa-cloud-sun text-yellow-500' : 'fa-moon text-indigo-400');
                        
                        header.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center">
                                    <i class="fa-solid ${icon} text-lg"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-700 text-sm">${time}</h4>
                                    <p class="text-[10px] text-slate-400 font-semibold">${takenCount} / ${totalCount} assunti</p>
                                </div>
                            </div>
                            <i id="chevron-${time}" class="fa-solid fa-chevron-down text-slate-300 transition-transform duration-300 ${rotateClass}"></i>
                        `;
                        container.appendChild(header);

                        // Contenitore Lista Farmaci (Nascosto/Visibile)
                        const listContainer = document.createElement('div');
                        listContainer.id = `list-${time}`;
                        listContainer.className = `space-y-3 ${hiddenClass}`;

                        meds.forEach(med => {
                            // 1. Controllo Override
                            let isToday = false;
                            
                            if (med.specificDays && med.specificDays[todayISO] !== undefined) {
                                // Se esiste un override per oggi, usalo.
                                // Il med Ã¨ attivo se il suo orario Ã¨ nell'array dell'override
                                isToday = med.specificDays[todayISO].includes(med.time);
                            } else {
                                // 2. Fallback su logica standard
                                const isFreqMatch = this.isMedicationDay(med, todayISO);
                                const isDayMatch = !Array.isArray(med.days) || med.days.length === 0 || med.days.includes(todayShort);
                                isToday = isFreqMatch && isDayMatch;
                            }

                            if (med.taken) anyTaken = true;
                            const card = document.createElement('div');
                            const categoryClass = `med-card-${time.toLowerCase()}`;
                            const inactiveClass = !isToday ? 'med-card-inactive' : '';
                            const takenClass = med.taken ? 'med-card-taken' : '';
                            const therapy = this.getTherapyStatus(med);
                            let therapyBadge = '';
                            if (therapy) {
                                therapyBadge = `
                                            <div class="therapy-badge ${therapy.cls}">
                                                <span class="label">${therapy.label}</span>
                                                <span class="dot">â€¢</span>
                                                <span class="sub">${therapy.sub}</span>
                                            </div>
                                        `;
                            }

                            if (!isToday) {
                                therapyBadge += `
                                            <div class="therapy-badge gray">
                                                <span class="label">Oggi non previsto</span>
                                            </div>
                                        `;
                            }

                            const noteBtn = med.usage ? 
                                `<button onclick="app.showMedNote('${med.id}')" class="text-amber-400 hover:text-amber-500 p-2" title="Leggi note"><i class="fa-solid fa-note-sticky"></i></button>` 
                                : '';

                            card.className = `p-4 rounded-xl card-shadow border mb-3 flex items-center justify-between transition-all ${categoryClass} ${takenClass} ${inactiveClass}`;
                            
                            // Strutturiamo il contenuto per separare la parte cliccabile (checkbox) dai bottoni azione
                            card.innerHTML = `
                                            <div class="flex items-center gap-4 flex-1 overflow-hidden card-main-content">
                                                <input type="checkbox" class="med-checkbox"
                                                ${med.taken ? 'checked' : ''}
                                                onchange="app.toggleMedication('${med.id}')">
                                                <div class="overflow-hidden cursor-pointer ${med.taken ? 'opacity-40' : ''}">
                                                    <h4 class="font-bold text-slate-800 leading-tight truncate">${med.name}</h4>
                                                    <div class="flex flex-col">
                                                        ${med.category ? `<p class="text-[10px] font-semibold text-slate-500 uppercase tracking-tighter">${med.category}</p>` : ''}
                                                        <div class="flex flex-col mt-0.5">
                                                            ${med.dose ? `<p class="text-xs text-blue-700 font-bold mb-0.5">${med.dose}</p>` : ''}
                                                            ${med.usage ? `<p class="text-[10px] text-slate-400 italic truncate">${med.usage}</p>` : ''}
                                                            ${therapyBadge}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex items-center card-actions">
                                                ${noteBtn}
                                                <button onclick="app.openEditMedModal('${med.id}')" class="text-blue-400 hover:text-blue-600 p-2"title="Modifica farmaco"><i class="fa-solid fa-pen"></i></button>
                                                <button onclick="app.deleteMedication('${med.id}')" class="text-red-400 hover:text-red-600 p-2"title="Elimina farmaco"><i class="fa-solid fa-trash-can"></i></button>
                                            </div>`;
                            listContainer.appendChild(card);
                        });
                        container.appendChild(listContainer);
                    }
                });
                document.getElementById('btn-uncheck-all').classList.toggle('hidden', !anyTaken);
                document.getElementById('med-empty-state').classList.toggle('hidden', hasMeds);
            },

            toggleSection(time) {
                if (this.expandedSections.includes(time)) {
                    this.expandedSections = this.expandedSections.filter(t => t !== time);
                } else {
                    this.expandedSections.push(time);
                }
                
                const list = document.getElementById(`list-${time}`);
                const chevron = document.getElementById(`chevron-${time}`);
                if (list) list.classList.toggle('hidden');
                if (chevron) chevron.classList.toggle('rotate-180');
            },

            closeModal(id) {
                document.getElementById(id).classList.add('hidden');
                if (id === 'modal-med') {
                    document.getElementById('input-med-edit-id').value = '';
                }
            },

            toggleTimeSelection(time, btn) {
                const idx = this.selectedTimes.indexOf(time);
                idx > -1 ? this.selectedTimes.splice(idx, 1) : this.selectedTimes.push(time);
                
                this.updateTimeUI();
            },
            
            updateTimeUI() {
                document.querySelectorAll('.time-btn').forEach(b => {
                    const val = b.dataset.val;
                    if(val) {
                        this.selectedTimes.includes(val) ? b.classList.add('selected') : b.classList.remove('selected');
                    }
                });
            },

            handleSwipe(endX, endY) {
                if (!this.currentProfileId) return;
                if (!document.getElementById('view-settings').classList.contains('hidden')) return;
                if (document.querySelector('.modal-overlay:not(.hidden)')) return;

                const diffX = endX - this.touchStartX;
                const diffY = endY - this.touchStartY;

                if (Math.abs(diffY) > Math.abs(diffX)) return;
                if (Math.abs(diffX) < 80) return;

                const currentIndex = this.data.profiles.findIndex(p => p.id === this.currentProfileId);

                if (diffX > 0) {
                    if (currentIndex > 0) {
                        this.openProfile(this.data.profiles[currentIndex - 1].id);
                    }
                }

                if (diffX < 0 && currentIndex < this.data.profiles.length - 1) {
                    this.openProfile(this.data.profiles[currentIndex + 1].id);
                }
            },

            setupManifest() {
                const manifest = {
                    "name": "MedicinePro",
                    "short_name": "MedPro",
                    "start_url": ".",
                    "display": "standalone",
                    "background_color": "#f3f4f6",
                    "theme_color": "#2563eb",
                    "icons": [{ "src": "https://img.icons8.com/color/192/pills-bottle.png", "sizes": "192x192", "type": "image/png" }]
                };
                const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                document.getElementById('my-manifest').setAttribute('href', URL.createObjectURL(blob));
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
